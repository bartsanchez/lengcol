---
- hosts: lengcolaws
  remote_user: ubuntu
  tasks:
    - import_tasks: tasks/setup_repo.yml

    - import_tasks: tasks/fail2ban.yml

    - name: Prune dangling images
      shell:
        chdir: /opt/apps/lengcol
        cmd: docker image prune -f

    - name: Pull new images
      shell:
        chdir: /opt/apps/lengcol
        cmd: docker-compose -f docker-compose.yml -f docker-compose.prod.yml pull

    - name: Build containers
      shell:
        chdir: /opt/apps/lengcol
        cmd: docker-compose -f docker-compose.yml -f docker-compose.prod.yml build

    - name: Stop running containers
      shell:
        chdir: /opt/apps/lengcol
        cmd: docker-compose -f docker-compose.yml -f docker-compose.prod.yml down

    - name: Start containers
      shell:
        chdir: /opt/apps/lengcol
        cmd: docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d

    - import_tasks: tasks/post_install.yml
